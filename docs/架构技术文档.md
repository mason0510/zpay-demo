# Z-Payæ”¯ä»˜æ¼”ç¤ºç³»ç»Ÿ - æ¶æ„æŠ€æœ¯æ–‡æ¡£

## ğŸ“‹ é¡¹ç›®æ¦‚è¿°

### é¡¹ç›®ä¿¡æ¯
- **é¡¹ç›®åç§°**: Z-Payæ”¯ä»˜æ¼”ç¤ºç³»ç»Ÿ
- **ç‰ˆæœ¬**: v1.0.0
- **å¼€å‘è¯­è¨€**: Node.js + JavaScript
- **éƒ¨ç½²ç¯å¢ƒ**: Docker + Nginx Proxy + Let's Encrypt
- **åŸŸå**: https://zpay.satoshitech.xyz

### é¡¹ç›®ç›®æ ‡
æ„å»ºä¸€ä¸ªå®‰å…¨ã€å¯é çš„ç¬¬ä¸‰æ–¹æ”¯ä»˜æ¥å…¥æ¼”ç¤ºç³»ç»Ÿï¼Œå±•ç¤ºå®Œæ•´çš„æ”¯ä»˜æµç¨‹ï¼ŒåŒ…æ‹¬è®¢å•åˆ›å»ºã€æ”¯ä»˜è¯·æ±‚ã€å›è°ƒéªŒè¯ç­‰æ ¸å¿ƒåŠŸèƒ½ã€‚

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

### æ•´ä½“æ¶æ„å›¾
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ·æµè§ˆå™¨     â”‚    â”‚   Nginx Proxy   â”‚    â”‚   Z-Payç½‘å…³     â”‚
â”‚                â”‚    â”‚                â”‚    â”‚                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   å‰ç«¯UI   â”‚â—„â”€â”¼â”€â”€â”€â”€â”¼â”€â”€â”¤ SSL/HTTPS â”‚  â”‚    â”‚  â”‚ æ”¯ä»˜å¤„ç†   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚                     â”‚
                                â–¼                     â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
                    â”‚  Dockerå®¹å™¨     â”‚               â”‚
                    â”‚                â”‚               â”‚
                    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚               â”‚
                    â”‚ â”‚ Node.js App â”‚ â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚ â”‚             â”‚ â”‚  
                    â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚  Callback
                    â”‚ â”‚ â”‚ Express â”‚ â”‚ â”‚  Notification
                    â”‚ â”‚ â”‚ Server  â”‚ â”‚ â”‚
                    â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
                    â”‚ â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚
                    â”‚ â”‚ â”‚ç­¾åéªŒè¯å™¨â”‚ â”‚ â”‚
                    â”‚ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚
                    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€æœ¯æ ˆé€‰å‹

#### åç«¯æŠ€æœ¯æ ˆ
- **è¿è¡Œç¯å¢ƒ**: Node.js 18.x
- **Webæ¡†æ¶**: Express 4.x
- **ç­¾åç®—æ³•**: MD5 (utilityåº“)
- **æ—¶é—´å¤„ç†**: Moment.js
- **ç¯å¢ƒé…ç½®**: dotenv
- **è·¨åŸŸå¤„ç†**: CORS

#### å‰ç«¯æŠ€æœ¯æ ˆ
- **UIæ¡†æ¶**: Material Design
- **æ ·å¼**: CSS3 + Google Fonts
- **å›¾æ ‡**: Material Icons
- **å“åº”å¼**: è‡ªé€‚åº”è®¾è®¡

#### è¿ç»´æŠ€æœ¯æ ˆ
- **å®¹å™¨åŒ–**: Docker
- **åå‘ä»£ç†**: nginx-proxy
- **SSLè¯ä¹¦**: Let's Encrypt (acme-companion)
- **ç½‘ç»œ**: Dockerç½‘ç»œæ¡¥æ¥

## ğŸ”§ æ ¸å¿ƒæ¨¡å—è®¾è®¡

### 1. ç­¾åéªŒè¯æ¨¡å— (ZPaySignatureValidator)

#### æ¨¡å—èŒè´£
- å®ç°Z-Payå®˜æ–¹MD5ç­¾åç®—æ³•
- æä¾›ç­¾åç”Ÿæˆã€éªŒè¯ã€è°ƒè¯•åŠŸèƒ½
- å¤„ç†æ”¯ä»˜è¯·æ±‚å’Œå›è°ƒé€šçŸ¥çš„ç­¾å

#### æ ¸å¿ƒæ–¹æ³•
```javascript
class ZPaySignatureValidator {
    // å‚æ•°æ’åºæ‹¼æ¥ (å®˜æ–¹ç®—æ³•)
    getVerifyParams(params)
    
    // ç”ŸæˆMD5ç­¾å
    generateSign(params)
    
    // éªŒè¯ç­¾å
    verifySign(params)
    
    // ç”Ÿæˆæ”¯ä»˜URL
    generatePaymentUrl(paymentData)
    
    // éªŒè¯å›è°ƒé€šçŸ¥
    verifyNotify(notifyData)
    
    // è°ƒè¯•ç­¾åè¿‡ç¨‹
    debugSign(params)
}
```

#### ç­¾åç®—æ³•å®ç°
```javascript
/**
 * Z-Pay MD5ç­¾åç®—æ³•
 * 1. å‚æ•°æŒ‰ASCIIç æ’åº(a-z)
 * 2. æ’é™¤signã€sign_typeã€ç©ºå€¼
 * 3. æ‹¼æ¥æˆ a=b&c=d&e=f æ ¼å¼
 * 4. æœ«å°¾è¿½åŠ å•†æˆ·å¯†é’¥
 * 5. MD5åŠ å¯†å¹¶è½¬å°å†™
 */
function generateSign(params) {
    const paramStr = getVerifyParams(params);
    const signStr = paramStr + this.pkey;
    return crypto.createHash('md5')
        .update(signStr, 'utf8')
        .digest('hex')
        .toLowerCase();
}
```

### 2. æ”¯ä»˜æœåŠ¡æ¨¡å—

#### APIæ¥å£è®¾è®¡

##### åˆ›å»ºæ”¯ä»˜è®¢å•
```http
POST /api/create-order
Content-Type: application/json

{
    "amount": "1.00",
    "productName": "æµ‹è¯•å•†å“",
    "paymentMethod": "wxpay",
    "customerName": "å®¢æˆ·å§“å",
    "customerEmail": "å®¢æˆ·é‚®ç®±"
}
```

**å“åº”æ ¼å¼:**
```json
{
    "success": true,
    "data": {
        "orderNo": "20250629095514498",
        "paymentUrl": "https://zpayz.cn/submit.php?...",
        "amount": "1.00",
        "productName": "æµ‹è¯•å•†å“",
        "paymentMethod": "wxpay"
    }
}
```

##### æ”¯ä»˜å›è°ƒé€šçŸ¥
```http
POST /api/notify
Content-Type: application/x-www-form-urlencoded

pid=xxx&name=xxx&money=xxx&out_trade_no=xxx&trade_no=xxx&trade_status=TRADE_SUCCESS&sign=xxx
```

#### ä¸šåŠ¡æµç¨‹è®¾è®¡

##### æ”¯ä»˜æµç¨‹
```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant F as å‰ç«¯
    participant B as åç«¯
    participant Z as Z-Pay

    U->>F: å¡«å†™æ”¯ä»˜ä¿¡æ¯
    F->>B: POST /api/create-order
    B->>B: ç”Ÿæˆè®¢å•å·
    B->>B: æ„å»ºæ”¯ä»˜å‚æ•°
    B->>B: è®¡ç®—ç­¾å
    B->>F: è¿”å›æ”¯ä»˜URL
    F->>U: è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
    U->>Z: å®Œæˆæ”¯ä»˜
    Z->>B: å‘é€å›è°ƒé€šçŸ¥
    B->>B: éªŒè¯ç­¾å
    B->>B: å¤„ç†ä¸šåŠ¡é€»è¾‘
    B->>Z: è¿”å›success
    Z->>U: è·³è½¬åˆ°ç»“æœé¡µé¢
```

### 3. é…ç½®ç®¡ç†æ¨¡å—

#### ç¯å¢ƒå˜é‡é…ç½®
```bash
# Z-Payå•†æˆ·é…ç½®
ZPAY_PID=2025062220300248
ZPAY_KEY=cQoq3mjY6v6O59AghN8bsJIIyhIdBUyn
ZPAY_GATEWAY=https://zpayz.cn/submit.php

# æœåŠ¡å™¨é…ç½®
PORT=3000
NODE_ENV=development

# å›è°ƒåœ°å€é…ç½®
NOTIFY_URL=https://zpay.satoshitech.xyz/api/notify
RETURN_URL=https://zpay.satoshitech.xyz/payment-result.html

# ç½‘ç«™ä¿¡æ¯
SITE_NAME=Z-Payæ¼”ç¤ºç³»ç»Ÿ
```

#### é…ç½®åŠ è½½æœºåˆ¶
```javascript
const ZPAY_CONFIG = {
    pid: process.env.ZPAY_PID || 'ä½ çš„pid',
    key: process.env.ZPAY_KEY || 'ä½ çš„key',
    gateway: process.env.ZPAY_GATEWAY || 'https://zpayz.cn/submit.php',
    notifyUrl: process.env.NOTIFY_URL || `http://localhost:${PORT}/api/notify`,
    returnUrl: process.env.RETURN_URL || `http://localhost:${PORT}/payment-result.html`,
    siteName: process.env.SITE_NAME || 'Z-Payæ¼”ç¤ºç³»ç»Ÿ'
};
```

## ğŸ”’ å®‰å…¨è®¾è®¡

### ç­¾åå®‰å…¨
- **MD5ç­¾åéªŒè¯**: æ‰€æœ‰è¯·æ±‚å¿…é¡»é€šè¿‡ç­¾åéªŒè¯
- **å‚æ•°å®Œæ•´æ€§**: é˜²æ­¢å‚æ•°ç¯¡æ”¹
- **é‡æ”¾æ”»å‡»é˜²æŠ¤**: è®¢å•å·å”¯ä¸€æ€§æ£€æŸ¥

### å›è°ƒå®‰å…¨
- **ç­¾åå¼ºåˆ¶éªŒè¯**: æ‹’ç»æ— æ•ˆç­¾åçš„å›è°ƒ
- **çŠ¶æ€éªŒè¯**: æ£€æŸ¥trade_statusç¡®ä¿æ”¯ä»˜æˆåŠŸ
- **å¹‚ç­‰æ€§å¤„ç†**: é˜²æ­¢é‡å¤å¤„ç†åŒä¸€è®¢å•

### ç½‘ç»œå®‰å…¨
- **HTTPSå¼ºåˆ¶**: å…¨ç«™SSLåŠ å¯†
- **CORSé…ç½®**: è·¨åŸŸè¯·æ±‚æ§åˆ¶
- **è¾“å…¥éªŒè¯**: å‚æ•°æ ¼å¼å’Œé•¿åº¦æ£€æŸ¥

## ğŸš€ éƒ¨ç½²æ¶æ„

### Dockerå®¹å™¨åŒ–
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm install --production
COPY . .
RUN mkdir -p logs
EXPOSE 3000
CMD ["npm", "start"]
```

### Nginxåå‘ä»£ç†
```yaml
environment:
  - VIRTUAL_HOST=zpay.satoshitech.xyz
  - LETSENCRYPT_HOST=zpay.satoshitech.xyz
  - LETSENCRYPT_EMAIL=admin@satoshitech.xyz
```

### ç½‘ç»œæ¶æ„
- **å¤–éƒ¨è®¿é—®**: Cloudflare â†’ Nginx Proxy â†’ åº”ç”¨å®¹å™¨
- **å†…éƒ¨é€šä¿¡**: Docker bridgeç½‘ç»œ
- **SSLç»ˆç«¯**: Let's Encryptè‡ªåŠ¨è¯ä¹¦ç®¡ç†

## ğŸ“Š æ€§èƒ½ä¸ç›‘æ§

### æ€§èƒ½æŒ‡æ ‡
- **å“åº”æ—¶é—´**: < 200ms (æœ¬åœ°å¤„ç†)
- **å¹¶å‘å¤„ç†**: Expressé»˜è®¤å¹¶å‘
- **å†…å­˜ä½¿ç”¨**: < 100MB (Node.jså®¹å™¨)

### æ—¥å¿—ç›‘æ§
```javascript
// ç»“æ„åŒ–æ—¥å¿—
console.log('æ”¶åˆ°æ”¯ä»˜é€šçŸ¥:', req.body);
console.log('ç­¾åéªŒè¯æˆåŠŸï¼Œæ”¯ä»˜é€šçŸ¥æœ‰æ•ˆ');
console.log(`è®¢å• ${out_trade_no} æ”¯ä»˜æˆåŠŸï¼Œé‡‘é¢ï¼š${money}å…ƒ`);
```

### é”™è¯¯å¤„ç†
```javascript
try {
    // ä¸šåŠ¡é€»è¾‘
} catch (error) {
    console.error('å¤„ç†å¤±è´¥:', error);
    res.status(500).json({
        success: false,
        message: 'ç³»ç»Ÿé”™è¯¯'
    });
}
```

## ğŸ§ª æµ‹è¯•ç­–ç•¥

### å•å…ƒæµ‹è¯•
- ç­¾åç®—æ³•æµ‹è¯•
- å‚æ•°éªŒè¯æµ‹è¯•
- è¾¹ç•Œæ¡ä»¶æµ‹è¯•

### é›†æˆæµ‹è¯•
- APIæ¥å£æµ‹è¯•
- æ”¯ä»˜æµç¨‹æµ‹è¯•
- å›è°ƒéªŒè¯æµ‹è¯•

### æµ‹è¯•ç”¨ä¾‹ç¤ºä¾‹
```javascript
// ç­¾åéªŒè¯æµ‹è¯•
const validator = new ZPaySignatureValidator(testKey);
const testParams = { /* æµ‹è¯•å‚æ•° */ };
const sign = validator.generateSign(testParams);
assert(validator.verifySign({...testParams, sign}));
```

## ğŸ“ˆ æ‰©å±•æ€§è®¾è®¡

### æ°´å¹³æ‰©å±•
- æ— çŠ¶æ€åº”ç”¨è®¾è®¡
- æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²
- è´Ÿè½½å‡è¡¡å‹å¥½

### åŠŸèƒ½æ‰©å±•
- æ”¯æŒå¤šç§æ”¯ä»˜æ–¹å¼
- è®¢å•çŠ¶æ€ç®¡ç†
- æ•°æ®åº“å­˜å‚¨
- å•†æˆ·ç®¡ç†ç³»ç»Ÿ

### ç›‘æ§æ‰©å±•
- é›†æˆAPMç›‘æ§
- ä¸šåŠ¡æŒ‡æ ‡ç»Ÿè®¡
- å‘Šè­¦æœºåˆ¶

## ğŸ”§ è¿ç»´æŒ‡å—

### éƒ¨ç½²æµç¨‹
```bash
# 1. æ„å»ºé•œåƒ
docker build -t zpay-demo .

# 2. å¯åŠ¨å®¹å™¨
docker run -d --name zpay-demo \
  -p 3000:3000 \
  --env-file .env \
  -e VIRTUAL_HOST=zpay.satoshitech.xyz \
  --network nginx-proxy \
  zpay-demo

# 3. æ£€æŸ¥çŠ¶æ€
docker logs zpay-demo
```

### æ•…éšœæ’æŸ¥
1. **ç­¾åéªŒè¯å¤±è´¥**: æ£€æŸ¥å¯†é’¥é…ç½®å’Œå‚æ•°æ ¼å¼
2. **å›è°ƒé€šçŸ¥å¼‚å¸¸**: æ£€æŸ¥ç½‘ç»œè¿é€šæ€§å’Œç­¾å
3. **å®¹å™¨å¯åŠ¨å¤±è´¥**: æ£€æŸ¥ç¯å¢ƒå˜é‡å’Œç«¯å£å ç”¨

### æ—¥å¸¸ç»´æŠ¤
- å®šæœŸæ£€æŸ¥å®¹å™¨çŠ¶æ€
- ç›‘æ§SSLè¯ä¹¦æœ‰æ•ˆæœŸ
- æŸ¥çœ‹åº”ç”¨æ—¥å¿—å¼‚å¸¸

## ğŸ“‹ APIæ–‡æ¡£

### æ¥å£æ¸…å•
| æ¥å£ | æ–¹æ³• | è·¯å¾„ | æè¿° |
|------|------|------|------|
| åˆ›å»ºè®¢å• | POST | /api/create-order | åˆ›å»ºæ”¯ä»˜è®¢å• |
| æ”¯ä»˜å›è°ƒ | POST | /api/notify | å¤„ç†æ”¯ä»˜é€šçŸ¥ |
| è®¢å•çŠ¶æ€ | GET | /api/order-status/:orderNo | æŸ¥è¯¢è®¢å•çŠ¶æ€ |

### é”™è¯¯ç å®šä¹‰
| é”™è¯¯ç  | æè¿° | è§£å†³æ–¹æ¡ˆ |
|--------|------|----------|
| 400 | å‚æ•°é”™è¯¯ | æ£€æŸ¥è¯·æ±‚å‚æ•° |
| 500 | æœåŠ¡å™¨é”™è¯¯ | æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿— |

## ğŸ“š å‚è€ƒèµ„æ–™

### æŠ€æœ¯æ–‡æ¡£
- [Z-Payå®˜æ–¹æ–‡æ¡£](https://zpayz.cn/)
- [Expresså®˜æ–¹æ–‡æ¡£](https://expressjs.com/)
- [Dockerå®˜æ–¹æ–‡æ¡£](https://docs.docker.com/)

### æœ€ä½³å®è·µ
- RESTful APIè®¾è®¡åŸåˆ™
- Node.jså®‰å…¨ç¼–ç¨‹è§„èŒƒ
- å¾®æœåŠ¡æ¶æ„æ¨¡å¼

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-06-29  
**ç»´æŠ¤è€…**: AI Assistant